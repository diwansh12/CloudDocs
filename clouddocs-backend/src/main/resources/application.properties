# ===== CORE APPLICATION SETTINGS =====
server.port=${PORT:8080}
server.servlet.context-path=/api
spring.application.name=CloudDocs Backend API
spring.profiles.active=${SPRING_PROFILES_ACTIVE:production}

# ✅ CRITICAL: Enable lazy initialization (saves 30-50MB startup)
spring.main.lazy-initialization=true

# ===== MEMORY-OPTIMIZED SERVER CONFIGURATION =====
# ✅ FIXED: Consistent minimal thread pool (was conflicting: max=3, min-spare=20)
server.tomcat.threads.max=3
server.tomcat.threads.min-spare=1
server.tomcat.accept-count=10
server.tomcat.max-connections=20
server.tomcat.connection-timeout=60000
server.tomcat.keep-alive-timeout=30000

# ✅ OPTIMIZED: Keep compression but disable memory-heavy HTTP/2
server.http2.enabled=false
server.compression.enabled=true
server.compression.mime-types=application/json,text/html,text/xml,text/plain
server.compression.min-response-size=1024

# ✅ SECURITY: Session cookie configuration
server.servlet.session.cookie.secure=true
server.servlet.session.cookie.http-only=true
server.servlet.session.cookie.same-site=strict

# ===== DATABASE CONFIGURATION =====
spring.datasource.url=${DATABASE_URL}
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}
spring.datasource.driver-class-name=org.postgresql.Driver

# ✅ OPTIMIZED: Reduced connection pool (was 5, now 2) 
spring.datasource.hikari.maximum-pool-size=2
spring.datasource.hikari.minimum-idle=1
spring.datasource.hikari.connection-timeout=20000
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.max-lifetime=600000
spring.datasource.hikari.leak-detection-threshold=15000

# ===== JPA/HIBERNATE CONFIGURATION =====
spring.jpa.hibernate.ddl-auto=update
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.defer-datasource-initialization=true
spring.jpa.show-sql=false
spring.jpa.open-in-view=false

# ✅ MEMORY OPTIMIZATION: Disable caches to prevent stale data
spring.jpa.properties.hibernate.cache.use_second_level_cache=false
spring.jpa.properties.hibernate.cache.use_query_cache=false
spring.jpa.properties.hibernate.cache.region.factory_class=org.hibernate.cache.internal.NoCachingRegionFactory

# ✅ OPTIMIZED: Reduced batch size (was 20, now 10)
spring.jpa.properties.hibernate.connection.autocommit=false
spring.jpa.properties.hibernate.transaction.flush_before_completion=true
spring.jpa.properties.hibernate.transaction.auto_close_session=true
spring.jpa.properties.hibernate.jdbc.batch_size=10
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true

# ✅ CRITICAL: OffsetDateTime and timezone configuration
spring.jpa.properties.hibernate.jdbc.time_zone=UTC
spring.jpa.properties.hibernate.timezone.default_storage=NORMALIZE

# ===== JACKSON/JSON CONFIGURATION =====
spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.time-zone=UTC
spring.jackson.serialization.fail-on-empty-beans=false

# ===== EMAIL CONFIGURATION =====
spring.mail.host=smtp.gmail.com
spring.mail.port=587
spring.mail.username=${MAIL_USERNAME}
spring.mail.password=${MAIL_PASSWORD}
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true

# ===== FILE STORAGE =====
# ✅ OPTIMIZED: Reduced file sizes for memory safety
spring.servlet.multipart.max-file-size=500KB
spring.servlet.multipart.max-request-size=1MB
spring.servlet.multipart.enabled=true
spring.servlet.multipart.resolve-lazily=true
spring.servlet.multipart.file-size-threshold=0

# ===== OPTIMIZED LOGGING (reduced verbosity to save memory) =====
logging.level.root=WARN
logging.level.com.clouddocs.backend=INFO
logging.level.com.clouddocs.backend.service.WorkflowService=INFO
logging.level.org.hibernate.SQL=WARN
logging.level.org.springframework.transaction=WARN
logging.level.org.springframework.orm.jpa=WARN
logging.level.org.springframework.web=WARN
logging.level.org.springframework.security=WARN

# ===== ACTUATOR/MONITORING (minimal exposure) =====
management.endpoints.web.exposure.include=health,info
management.endpoint.health.show-details=when-authorized

# ===== OPTIMIZED TASK SCHEDULING =====
# ✅ REDUCED: Thread pools (was 50 max, now 8)
spring.task.scheduling.pool.size=2
spring.task.execution.pool.core-size=3
spring.task.execution.pool.max-size=8
spring.task.execution.pool.queue-capacity=50
spring.task.execution.pool.allow-core-thread-timeout=true
spring.task.execution.pool.keep-alive=60s
spring.task.execution.thread-name-prefix=workflow-task-

# ===== TRANSACTION CONFIGURATION =====
spring.transaction.default-timeout=30
spring.transaction.rollback-on-commit-failure=true

# ===== ERROR HANDLING =====
server.error.include-exception=false
server.error.include-message=always
server.error.include-binding-errors=never
server.error.include-stacktrace=never

# ===== GRACEFUL SHUTDOWN =====
server.shutdown=graceful
spring.lifecycle.timeout-per-shutdown-phase=10s

# ✅ MEMORY: Disable JMX (saves ~10MB)
spring.jmx.enabled=false
spring.devtools.restart.enabled=false

# ===== YOUR TWILIO CONFIGURATION (KEPT) =====
app.twilio.account-sid=${TWILIO_ACCOUNT_SID}
app.twilio.auth-token=${TWILIO_AUTH_TOKEN}
app.twilio.phone=${TWILIO_PHONE}

# ===== JWT CONFIGURATION (KEPT) =====
app.jwtSecret=${JWT_SECRET}
app.jwtExpirationMs=86400000

# ===== CORS CONFIGURATION (KEPT) =====
app.cors.allowed-origins=${CORS_ORIGINS:https://cloud-docs-tan.vercel.app,http://localhost:3000}

# ===== FILE UPLOAD CONFIGURATION (KEPT) =====
file.upload-dir=./uploads

# ===== FIREBASE CONFIGURATION (KEPT) =====
app.firebase.service-account-key=${FIREBASE_SERVICE_ACCOUNT_KEY}

# ===== WORKFLOW CONFIGURATION (KEPT) =====
app.workflow.default-sla-hours=24
app.workflow.max-concurrent-workflows=50
app.workflow.auto-cleanup-days=90

# ===== ANALYTICS CONFIGURATION (KEPT) =====
app.analytics.cache-duration=300
app.analytics.max-date-range-days=365

# ===== NOTIFICATION CONFIGURATION (KEPT) =====
app.notifications.email-enabled=true
app.notifications.sms-enabled=true
app.notifications.batch-size=25

# ===== AUDIT CONFIGURATION (KEPT) =====
app.audit.enabled=true
app.audit.retention-days=365
app.audit.async-enabled=true

# ===== RATE LIMITING (OPTIMIZED) =====
app.rate-limit.enabled=true
app.rate-limit.requests-per-minute=500
app.rate-limit.burst-capacity=750

# ===== AI FEATURES (KEPT) =====
ai.search.enabled=true
ai.chat.enabled=true
ai.embedding.enabled=true

# ===== AI PROVIDERS (KEPT) =====
ai.providers.openai.enabled=true
ai.providers.openai.priority=1
openai.api.key=${OPENAI_API_KEY}

ai.providers.cohere.enabled=true
ai.providers.cohere.priority=2
ai.providers.cohere.api-key=${COHERE_API_KEY:}
ai.providers.cohere.model=embed-english-v3.0

ai.providers.health-check.enabled=true
ai.providers.health-check.interval=300000

ai.fallback.enabled=true
ai.fallback.max-retries=3
ai.fallback.retry-delay=2000

# ===== OCR CONFIGURATION (KEPT & OPTIMIZED) =====
ocr.enabled=${OCR_ENABLED:true}
ocr.timeout=${OCR_TIMEOUT:120000}
ocr.max-file-size=${OCR_MAX_FILE_SIZE:1MB}

# ===== TESSERACT CONFIGURATION (KEPT) =====
tesseract.path=${TESSERACT_PATH:/usr/bin/tesseract}
tesseract.datapath=${TESSERACT_DATAPATH:/usr/share/tessdata}
tesseract.language=eng
tesseract.psm=1
tesseract.oem=3

# ===== OCR OPTIMIZATION SETTINGS =====
app.ocr.max-file-size-mb=1
app.ocr.max-dimension=500
app.ocr.enable-compression=true
app.ocr.memory-threshold-percent=60

# ===== REDIS CONFIGURATION (OPTIMIZED) =====
spring.data.redis.host=${REDIS_HOST}
spring.data.redis.port=${REDIS_PORT}
spring.data.redis.password=${REDIS_PASSWORD}
spring.data.redis.username=${REDIS_USERNAME}
spring.data.redis.database=0
spring.data.redis.timeout=30000ms

# ✅ OPTIMIZED: Redis connection pool (was 25 max, now 3)
spring.data.redis.lettuce.pool.max-active=3
spring.data.redis.lettuce.pool.max-idle=1
spring.data.redis.lettuce.pool.min-idle=0
spring.data.redis.lettuce.pool.max-wait=5000ms

# ✅ OPTIMIZED: Shorter cache TTL (was 30min, now 10min)
spring.cache.type=redis
spring.cache.redis.time-to-live=600000
spring.cache.redis.cache-null-values=false

# ===== HTTP REQUEST HANDLING (OPTIMIZED) =====
server.tomcat.max-http-form-post-size=2MB
server.tomcat.max-swallow-size=2MB
spring.mvc.async.request-timeout=120000
